# Auto-generated by AutoRollback Tool
# Generated on: 2025-10-31T08:10:49.537404Z

name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for rollback'
        required: true
        type: string
      failed_run_id:
        description: 'ID of the failed deployment run'
        required: false
        type: string
  repository_dispatch:
    types: [rollback-trigger]

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}

jobs:
  rollback:
    name: Rollback to Previous Version
    runs-on: ubuntu-latest
    
    steps:
      - name: Log Rollback Event
        run: |
          echo "üîÑ ROLLBACK INITIATED"
          echo "Reason: ${{ github.event.inputs.reason || github.event.client_payload.reason }}"
          echo "Failed Run ID: ${{ github.event.inputs.failed_run_id || 'N/A' }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date -u)"
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Rollback App Service Deployment
        run: |
          echo "üîÑ Rolling back App Service: my-app-staging-wuy1vl"
          
          # Get previous deployment slot or restore from backup
          az webapp deployment slot swap \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name my-app-staging-wuy1vl \
            --slot staging \
            --target-slot production || echo "‚ö†Ô∏è  No staging slot available"
          
          # Alternative: Restore from previous version
          echo "‚úÖ Rollback command executed"

      
      - name: Verify Rollback Success
        run: |
          echo "‚è≥ Waiting 20 seconds for rollback to complete..."
          sleep 20
          
          echo "üîç Verifying application health after rollback..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.APP_URL }}/healthz || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Rollback successful! Application is healthy."
            exit 0
          else
            echo "‚ùå Rollback verification failed (HTTP $HTTP_STATUS)"
            echo "‚ö†Ô∏è  Manual intervention required!"
            exit 1
          fi
      
      - name: Send Notification
        if: always()
        run: |
          echo "üìß Sending rollback notification to: halidu.mubasir@cloudfruition.com"
          # In production, integrate with email service or Slack
